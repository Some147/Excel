Function XVLOOKUP(lookup_value As Variant, lookup_range As Range, return_range As Range, _
                  Optional match_mode As Long = 0, Optional search_mode As Long = 1) As Variant
    Dim cell As Range
    Dim found As Boolean
    Dim i As Long
    Dim lookup_values As Variant
    Dim return_values As Variant
    Dim result As Variant
    
    ' Error handling
    On Error GoTo ErrorHandler
    
    ' Ensure ranges have the same size
    If lookup_range.Rows.Count <> return_range.Rows.Count Or _
       lookup_range.Columns.Count <> return_range.Columns.Count Then
        XVLOOKUP = CVErr(xlErrValue)
        Exit Function
    End If
    
    lookup_values = lookup_range.Value
    return_values = return_range.Value
    found = False
    
    ' Linear search
    If search_mode = 1 Then
        For i = 1 To UBound(lookup_values, 1)
            If (match_mode = 0 And lookup_values(i, 1) = lookup_value) Or _
               (match_mode = 1 And lookup_values(i, 1) Like lookup_value) Then
                result = return_values(i, 1)
                found = True
                Exit For
            End If
        Next i
        
    ' Reverse search
    ElseIf search_mode = -1 Then
        For i = UBound(lookup_values, 1) To 1 Step -1
            If (match_mode = 0 And lookup_values(i, 1) = lookup_value) Or _
               (match_mode = 1 And lookup_values(i, 1) Like lookup_value) Then
                result = return_values(i, 1)
                found = True
                Exit For
            End If
        Next i
    End If
    
    ' If no match is found
    If Not found Then
        result = CVErr(xlErrNA)
    End If
    
    XVLOOKUP = result
    Exit Function
    
ErrorHandler:
    XVLOOKUP = CVErr(xlErrValue)
End Function